services:
  - type: web
    name: campus-bridge
    runtime: node
    nodeVersion: 18.x
    buildCommand: |
      # ===== INIT =====
      export PROJECT_ROOT="/opt/render/project/src"
      echo "‚öôÔ∏è  PROJECT_ROOT set to: $PROJECT_ROOT"

      # ===== FRONTEND FIRST =====
      echo "üñ•Ô∏è  FRONTEND SETUP"
      cd $PROJECT_ROOT/frontend
      echo "üì¶ Installing frontend dependencies..."
      npm install --no-audit --no-fund

      echo "üöß Building frontend..."
      npx vite build || (echo '‚ùå Vite build failed' && exit 1)

      # ===== BACKEND SETUP =====
      echo "üîß BACKEND SETUP"
      cd $PROJECT_ROOT/backend
      echo "üìÇ Directory contents:"
      ls -la

      echo "üßπ Cleaning previous installs..."
      rm -rf node_modules package-lock.json .npmrc

      echo "üìù Configuring npm..."
      echo "legacy-peer-deps=true" > .npmrc
      echo "strict-peer-deps=false" >> .npmrc
      echo "save-exact=true" >> .npmrc

      echo "üì¶ Installing backend dependencies..."
      npm install --production=false --no-audit --no-fund --force
      echo "‚úÖ Backend dependencies verified:"
      npm list express --depth=0

      # ===== FINAL CHECK =====
      echo "üîç Final verification"
      node -e "
        console.log('‚úÖ Express location:', require.resolve('express'));
        console.log('‚úÖ Working directory:', process.cwd());
      "
    startCommand: |
      # ===== STARTUP =====
      export PROJECT_ROOT="/opt/render/project/src"
      cd $PROJECT_ROOT/backend
      export NODE_PATH="$PROJECT_ROOT/backend/node_modules"

      echo "üöÄ STARTUP CHECKS:"
      echo "1. Current directory: $(pwd)"
      echo "2. NODE_PATH: $NODE_PATH"
      node -e "
        try {
          console.log('‚úÖ Express resolved at:', require.resolve('express'));
          console.log('‚úÖ Module paths:', module.paths);
        } catch (e) {
          console.error('‚ùå CRITICAL ERROR:', e);
          process.exit(1);
        }
      "

      echo "‚è≥ Starting server..."
      node server.js
    envVars:
      - key: NODE_PATH
        value: "/opt/render/project/src/backend/node_modules"
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 10000
    healthCheckPath: /api/health
    autoDeploy: true
